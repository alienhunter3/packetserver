{% extends "base.html" %}

{% block title %}Dashboard - {{ current_user }}{% endblock %}

{% block content %}
<h2>Recent Bulletins</h2>

{% if bulletins %}
    <ul class="bulletin-list">
    {% for bull in bulletins %}
        <li>
            <strong><a href="/bulletins/{{ bull.id }}">{{ bull.subject }}</a></strong>
            <span class="meta">by {{ bull.author }} on {{ bull.created_at[:10] }}</span>
            <div class="preview">{{ bull.body[:150] }}{% if bull.body|length > 150 %}...{% endif %}</div>
        </li>
    {% endfor %}
    </ul>
    <p><a href="/bulletins">View all bulletins →</a></p>
{% else %}
    <p>No bulletins yet.</p>
    <p><a href="/bulletins/new">Create the first one!</a></p>
{% endif %}

<h2 class="mb-4">Messages</h2>

<!-- Compose Modal -->
<div class="modal fade" id="composeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="composeForm">
                <div class="modal-header">
                    <h5 class="modal-title">Compose Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">To (comma-separated callsigns or ALL):</label>
                        <input type="text" class="form-control" name="to" required placeholder="W1AW,N0CALL or ALL">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message:</label>
                        <textarea class="form-control" name="text" rows="5" required></textarea>
                    </div>
                    <div id="composeAlert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send</button>
                </div>
            </form>
        </div>
    </div>
</div>

<button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#composeModal">
    Compose New Message
</button>

<table class="table table-striped table-hover">
    <thead class="table-dark">
        <tr>
            <th>From</th>
            <th>To</th>
            <th>Preview</th>
            <th>Date</th>
            <th>Read</th>
        </tr>
    </thead>
    <tbody>
        {% for msg in messages %}
        <tr class="clickable-row" style="cursor: pointer;" onclick="window.location='/dashboard/message/{{ msg.id }}'">
            <td>{{ msg.from }}</td>
            <td>{{ msg.to | join(', ') }}</td>
            <td>{{ msg.text | truncate(60) | escape }}</td>
            <td>{{ msg.sent_at | replace('Z', '') }}</td>
            <td>{% if msg.retrieved %}<span class="text-success">✓</span>{% else %}<span class="text-warning">●</span>{% endif %}</td>
        </tr>
        {% else %}
        <tr><td colspan="5" class="text-center">No messages</td></tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('composeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const to = formData.get('to').split(',').map(s => s.trim().toUpperCase());
        const payload = {
            to: to,
            text: formData.get('text')
        };

        try {
            const resp = await fetch('/api/v1/messages', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload),
                credentials: 'include'  // sends Basic Auth
            });
            if (resp.ok) {
                const result = await response.json();
                let msg = 'Message sent!';
                if (result.warning) msg += ` ${result.warning}`;
                status.textContent = msg;
                document.getElementById('composeAlert').innerHTML = '<div class="alert alert-success">' + msg + '</div>';
                setTimeout(() => location.reload(), 1500);
            } else {
                const err = await resp.json();
                document.getElementById('composeAlert').innerHTML = '<div class="alert alert-danger">Error: ' + (err.detail || resp.status) + '</div>';
            }
        } catch (err) {
            document.getElementById('composeAlert').innerHTML = '<div class="alert alert-danger">Network error</div>';
        }
    });
</script>
{% endblock %}